# Clash é…ç½®ç¤ºä¾‹ - åŸºç¡€ç”¨æ³•

# ========================================
# è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Clash é…ç½®ç¤ºä¾‹
# å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Parsers åŠŸèƒ½æ·»åŠ ä½å®…ä»£ç†
# ========================================

port: 7890
socks-port: 7891
allow-lan: true
mode: Rule
log-level: info
external-controller: :9090

# ========================================
# Parsers é…ç½® - å…³é”®éƒ¨åˆ†
# ========================================
parsers:
  - url: https://your-subscription-url.com/clash
    code: |
      /**
       * Clash é…ç½®æ–‡ä»¶é¢„å¤„ç†è„šæœ¬ - å®¶å®½ä»£ç†å‰ç½®è·¯ç”±
       * ç‰ˆæœ¬: v1.0.0
       */

      const main = (config) => {
        // ================= é…ç½®åŒºåŸŸ =================
        const CONFIG = {
          residentialProxy: {
            name: "ğŸ  ç¾å›½ä½å®…ä»£ç†",
            type: "http",
            server: "proxy.example.com",
            port: 443,
            username: "your_username",
            password: "your_password",
            udp: true,
            tls: false,
            skipCertVerify: true,
            dialerProxy: "ğŸ‡ºğŸ‡¸ å®¶å®½å‰ç½®è·¯ç”±"
          },
          relayGroupName: "ğŸ‡ºğŸ‡¸ å®¶å®½å‰ç½®è·¯ç”±",
          sourceGroupName: "Proxies",
          targetGroups: ["Proxies", "Netflix", "AI", "TikTok", "DisneyPlus", "HBO", "YouTube", "âœˆï¸Final"],
          excludeNodes: ["DIRECT", "REJECT", "ğŸ¯Direct"]
        };

        // ================= æ—¥å¿—å‡½æ•° =================
        const log = {
          info: (msg) => console.log(`âœ… ${msg}`),
          warn: (msg) => console.log(`âš ï¸  ${msg}`),
          error: (msg) => console.error(`âŒ ${msg}`)
        };

        // ================= æ•°æ®æ ¡éªŒ =================
        if (!config || typeof config !== 'object') {
          log.error("é…ç½®å¯¹è±¡æ— æ•ˆ");
          return config;
        }

        if (!config.proxies) config.proxies = [];
        if (!config['proxy-groups']) config['proxy-groups'] = [];

        if (!Array.isArray(config.proxies) || !Array.isArray(config['proxy-groups'])) {
          log.error("proxies æˆ– proxy-groups æ ¼å¼é”™è¯¯");
          return config;
        }

        // ================= æ£€æŸ¥é‡å¤ =================
        const existingProxy = config.proxies.find(p => p.name === CONFIG.residentialProxy.name);
        if (existingProxy) {
          log.warn("å®¶å®½ä»£ç†å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ ");
          return config;
        }

        // ================= æå–èŠ‚ç‚¹åˆ—è¡¨ =================
        const sourceGroup = config['proxy-groups'].find(g => g.name === CONFIG.sourceGroupName);
        if (!sourceGroup) {
          log.error(`æ‰¾ä¸åˆ°æºç­–ç•¥ç»„: ${CONFIG.sourceGroupName}`);
          return config;
        }

        if (!sourceGroup.proxies || !Array.isArray(sourceGroup.proxies)) {
          log.error(`æºç­–ç•¥ç»„ ${CONFIG.sourceGroupName} æ²¡æœ‰æœ‰æ•ˆçš„ proxies å­—æ®µ`);
          return config;
        }

        const excludeSet = new Set([...CONFIG.excludeNodes, CONFIG.residentialProxy.name]);
        const availableNodes = (sourceGroup.proxies || []).filter(p => !excludeSet.has(p));

        if (availableNodes.length === 0) {
          log.warn("æ²¡æœ‰å¯ç”¨çš„èŠ‚ç‚¹ï¼Œä»…æ·»åŠ  DIRECT é€‰é¡¹");
        }

        log.info(`æå–åˆ° ${availableNodes.length} ä¸ªå¯ç”¨èŠ‚ç‚¹`);

        // ================= åˆ›å»º/æ›´æ–°å½±å­ç­–ç•¥ç»„ =================
        const existingRelayGroup = config['proxy-groups'].find(g => g.name === CONFIG.relayGroupName);
        const relayGroup = {
          name: CONFIG.relayGroupName,
          type: "select",
          proxies: ["DIRECT", ...availableNodes]
        };

        if (existingRelayGroup) {
          log.warn("å½±å­ç­–ç•¥ç»„å·²å­˜åœ¨ï¼Œæ›´æ–°èŠ‚ç‚¹åˆ—è¡¨");
          Object.assign(existingRelayGroup, relayGroup);
        } else {
          config['proxy-groups'].unshift(relayGroup);
          log.info(`åˆ›å»ºå½±å­ç­–ç•¥ç»„: ${CONFIG.relayGroupName}`);
        }

        // ================= åˆ›å»ºå®¶å®½ä»£ç†èŠ‚ç‚¹ =================
        const residentialProxy = {
          name: CONFIG.residentialProxy.name,
          type: CONFIG.residentialProxy.type,
          server: CONFIG.residentialProxy.server,
          port: CONFIG.residentialProxy.port,
          username: CONFIG.residentialProxy.username,
          password: CONFIG.residentialProxy.password,
          udp: CONFIG.residentialProxy.udp,
          tls: CONFIG.residentialProxy.tls,
          "skip-cert-verify": CONFIG.residentialProxy.skipCertVerify,
          "dialer-proxy": CONFIG.residentialProxy.dialerProxy
        };

        config.proxies.unshift(residentialProxy);
        log.info(`æ·»åŠ å®¶å®½ä»£ç†: ${CONFIG.residentialProxy.name}`);

        // ================= æ·»åŠ åˆ°ç›®æ ‡ç­–ç•¥ç»„ =================
        const targetGroupSet = new Set(CONFIG.targetGroups);
        let addedCount = 0;

        config['proxy-groups'].forEach(group => {
          if (targetGroupSet.has(group.name)) {
            if (!group.proxies) group.proxies = [];
            if (!group.proxies.includes(residentialProxy.name)) {
              group.proxies.unshift(residentialProxy.name);
              addedCount++;
            }
          }
        });

        log.info(`å·²å°†å®¶å®½ä»£ç†æ·»åŠ åˆ° ${addedCount} ä¸ªç­–ç•¥ç»„`);

        // ================= å®Œæˆ =================
        log.info("é…ç½®å¤„ç†å®Œæˆ");

        return config;
      };

# ========================================
# ä½¿ç”¨è¯´æ˜
# ========================================
# 
# 1. å°†æ­¤æ–‡ä»¶ä¿å­˜ä¸º clash_config.yaml
# 2. ä¿®æ”¹ parsers ä¸­çš„è®¢é˜…é“¾æ¥
# 3. ä¿®æ”¹ä»£ç†é…ç½®ï¼ˆserver, port, username, passwordï¼‰
# 4. åœ¨ Clash å®¢æˆ·ç«¯ä¸­å¯¼å…¥æ­¤é…ç½®
# 5. æ›´æ–°è®¢é˜…åå³å¯ä½¿ç”¨
#
# ========================================
